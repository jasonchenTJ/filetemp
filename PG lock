如何监控未提交的事务

select locktype,
relation::regclass as rel,
virtualxid as vxid,
transactionid as xid ,
virtualtransaction as vxid2,
pid,
mode,
granted
from pg_locks where relation::regclass::text ~~ '%instalment%';


2.监控未提交事务的时间长度

select
l.locktype,
l.relation::regclass as rel,
l.virtualxid as vxid,
l.transactionid as xid ,
l.virtualtransaction as vxid2,
l.pid,
l.mode,
l.granted,
to_char(p.query_start,'YYYY-MM-DD hh24:mi:ss') as start_time,
now() - p.query_start as duarion
from pg_locks l left join  pg_stat_activity p  on l.pid = p.pid where l.relation::regclass::text ~~ '%instalment%';

3.监控锁等待

SELECT w.query                          AS waiting_query,
       w.pid                            AS waiting_pid,
       w.usename                        AS waiting_user,
       now() - w.query_start            AS waiting_duration,
       l.query                          AS locking_query,
       l.pid                            AS locking_pid,
       l.usename                        AS locking_user,
       t.schemaname || '.' || t.relname AS tablename,
       now() - l.query_start            AS locking_duration
FROM pg_stat_activity w
         JOIN pg_locks l1 ON w.pid = l1.pid AND NOT l1.granted
         JOIN pg_locks l2 ON l1.relation = l2.relation AND l2.granted
         JOIN pg_stat_activity l ON l2.pid = l.pid
         JOIN pg_stat_user_tables t ON l1.relation = t.relid
;




模拟锁： 